{% extends "header.html.j2" %}

{% block content %}
    <span id="statsGrid">
      <span class="title">
        Player Stats for
        <span id="statsPlayerHeader" title="Click to reset all filters" onclick="dropAllFilters()">
          {{stats.name}} ({{stats.tag}})
        </span>
      </span>
      <span class="subtitle">
        {{stats.subtitle}}
      </span>

      <script type="text/javascript">
        function filterResults(me) {
          var here = window.location.href;
          var q    = $(me).data('q');
          here     = removeParam("ndays",removeParam("ngames",here));
          if (q != "") {
            here = addParam(q,here);
          }
          window.location.href = ensureQuery(here);
        }
        function dropAllFilters() {
          var here = window.location.href;
          here     = removeParam("char",here);
          here     = removeParam("vs",here);
          here     = removeParam("stage",here);
          here     = removeParam("against",here);
          window.location.href = ensureQuery(here);
        }
        function changeOrDropUrlParam(param,val) {
          var here = window.location.href;
          here     = removeParam(param,here);
          if ((val != undefined) && (val != getUrlVars()[param])) {
            here = addParam(param+"="+val,here);
          }
          window.location.href = ensureQuery(here);
        }
        function changeChar(c) {
          changeOrDropUrlParam("char",c);
        }
        function changeOpponent(c) {
          changeOrDropUrlParam("vs",c);
        }
        function changeStage(s) {
          changeOrDropUrlParam("stage",s);
        }
        function changeAgainst(s) {
          if (s != undefined) {
            s = s.replace("#","_");
          }
          changeOrDropUrlParam("against",s);
        }
        window.onload = function() {
          var uvars = getUrlVars();
          if ("ndays" in uvars) {
            $("button[data-q='ndays="+uvars["ndays"]+"']").addClass("active-button");
          }
          else if ("ngames" in uvars) {
            $("button[data-q='ngames="+uvars["ngames"]+"']").addClass("active-button");
          } else {
            $("button[data-q='']").addClass("active-button");
          }
        }
      </script>

      <span class="statFilterButtons">
        <button data-q='ndays=7'      onclick="filterResults(this)">Week       </button>
        <button data-q='ndays=28'     onclick="filterResults(this)">Month      </button>
        <button data-q='ndays=365'    onclick="filterResults(this)">Year       </button>
        <button data-q='ngames=100'   onclick="filterResults(this)">100 Games  </button>
        <button data-q='ngames=1000'  onclick="filterResults(this)">1000 Games </button>
        <button data-q='ngames=10000' onclick="filterResults(this)">10000 Games</button>
        <button data-q=''             onclick="filterResults(this)">Lifetime   </button>
      </span>

      {# Mains, Secondaries, and Other Characters #}
      <span class="h" id="hchars"><hr/>Most Played Characters<hr/></span>
      <span class="h" id="hmatchups"><hr/>Win Rates by Matchup<hr/></span>
      <span class="h" id="hstages"><hr/>Win Rates by Stage<hr/></span>
      <span class="h" id="hmostgames"><hr/>Most Played Opponents<hr/></span>
      <span class="h" id="hnewgames"><hr/>Most Recent Opponents<hr/></span>
      <span class="h" id="hhistory"><hr/>Games Played by Date<hr/></span>

      <span id="statsChars">
        {% for c in stats.char %}
          {% set playcount = (c[1:7]|sum) %}
          {% if playcount > 0 %}
            {% set playpercent = ((1000*(playcount)/stats.count)|int)/10 %}
            {% set cname = intchardata[c[0]]['intname'] %}
            {% if loop.index == 1 %}
              {% set role = "main" %}
            {% elif loop.index <= 3 %}
              {% set role = "second" %}
            {% else %}
              {% set role = "other" %}
            {% endif %}
            <span class="charGrid {{role}}">
              <span class="portrait">
                {% set click="changeChar("+(c[0]|string)+")" %}
                <a onclick="{{click}}"><img title="{{ cname }} ({{playpercent}}%)&#10;(Click to filter results by character)" src="{{ url_for('static',filename='icons/css') }}/{{ cname }}{{ c[7] }}.png" /></a>
              </span>
              <span class="playtime">
                {{ playpercent }}%
              </span>
            </span>
          {% endif %}
        {% endfor %}
      </span>

      {# Win / Loss / Draw rate for each matchup #}
      {% if stats.opp[13][1] + stats.opp[13][2] == 0 %}
        {% set onecol = "oneColumn" %}
      {% endif %}
      <span id="statsMatchups" class="{{onecol}}">
        <table id="byBestChar">
          <tr>
            <th title="Opponent's Character">Vs.</th>
            <th>W</th>
            <th>L</th>
            {# <th>D</th> #}
            <th>Win%</th>
          </tr>
          {% for mu in stats.opp[:stats.splitpoint] %}
            {% if mu[1]+mu[2] > 0 %}
              {% set click="changeOpponent("+(mu[0]|string)+")" %}
              <tr title="Click to filter by games vs. {{intchardata[mu[0]]['name']}}" class="clickable" onclick="{{click}}">
                <td><img src="{{ url_for('static',filename='icons/stock') }}/{{ intchardata[mu[0]]['intname'] }}0.png"/></td>
                <td>{{mu[1]}}</td>
                <td>{{mu[2]}}</td>
                {# <td>{{mu[3]}}</td> #}
                <td>{{ (100*mu[1] / ([mu[1]+mu[2],1] | max)) | int }}%</td>
              </tr>
            {% endif %}
          {% endfor %}
        </table>
        {% if stats.opp[13][2] + stats.opp[13][2] > 0 %}
          <table id="byWorstChar">
            <tr>
              <th title="Opponent's Character">Vs.</th>
              <th>W</th>
              <th>L</th>
              {# <th>D</th> #}
              <th>Win%</th>
            </tr>
            {% for mu in stats.opp[stats.splitpoint:] %}
              {% if mu[1]+mu[2] > 0 %}
                {% set click="changeOpponent("+(mu[0]|string)+")" %}
                <tr title="Click to filter by games vs. {{intchardata[mu[0]]['name']}}" class="clickable" onclick="{{click}}">
                  <td><img src="{{ url_for('static',filename='icons/stock') }}/{{ intchardata[mu[0]]['intname'] }}0.png"/></td>
                  <td>{{mu[1]}}</td>
                  <td>{{mu[2]}}</td>
                  {# <td>{{mu[3]}}</td> #}
                  <td>{{ (100*mu[1] / ([mu[1]+mu[2],1] | max)) | int }}%</td>
                </tr>
              {% endif %}
            {% endfor %}
          </table>
        {% endif %}
      </span>

      <span id="statsStages">
        <table id="byStage">
          <tr>
            <th>Stage</th>
            <th>W</th>
            <th>L</th>
            {# <th>D</th> #}
            <th>Win%</th>
          </tr>
          {% for mu in stats.stg %}
            {% if mu[1]+mu[2] > 0 %}
              {% if mu[0] >= 0 %}
                {% set click="changeStage("+(mu[0]|string)+")" %}
              {% endif %}
              <tr title="Click to filter by games on {{intstagedata[mu[0]]['name']}}" class="clickable" onclick="{{click}}">
                {% if mu[0] >= 0 %}
                  <td style="background-position: -40px -70px; background-image:url({{url_for('static',filename='icons/stage')}}/{{ intstagedata[mu[0]]['intname'] }}.png)">{{ intstagedata[mu[0]]['name'] }}</td>
                {% else %}
                  <td>Other Stages</td>
                {% endif %}
                <td>{{mu[1]}}</td>
                <td>{{mu[2]}}</td>
                {# <td>{{mu[3]}}</td> #}
                <td>{{ (100*mu[1] / ([mu[1]+mu[2],1] | max)) | int }}%</td>
              </tr>
            {% endif %}
          {% endfor %}
        </table>
      </span>

      {# Most Played Opponents #}
      <span id="statsMost">
        <table>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>W</th>
            <th>L</th>
            {# <th>D</th> #}
          </tr>
          {% for o in stats.top %}
            <tr title="Click to filter by games against {{o[3]}}" class="clickable" onclick="changeAgainst('{{o[3]}}')">
              {% if o[0] > o[1] %}
                {% if o[1] == 0 %}
                  {% set outcome = "p" %}
                {% else %}
                  {% set outcome = "w" %}
                {% endif %}
              {% elif o[1] > o[0] %}
                {% if o[0] == 0 %}
                  {% set outcome = "f" %}
                {% else %}
                  {% set outcome = "l" %}
                {% endif %}
              {% else %}
                {% set outcome = "d" %}
              {% endif %}
              {# <td><a href="/stats/{{ o[3]|replace('#', '_', 1) }}{{DEF_STATS}}">{{ o[3] }}</a></td> #}
              <td class="conncode" onclick="changeAgainst('{{o[3]}}')">{{ o[3] }}</td>
              {# <td><a href="/stats/{{ o[3]|replace('#', '_', 1) }}?submit=">{{ o[3] }}</a></td> #}
              <td>{{ o[4] }}</td>
              <td class="w{{outcome}}">{{ o[0] }}</td>
              <td class="l{{outcome}}">{{ o[1] }}</td>
              {# <td>{{ o[2] }}</td> #}
            </tr>
          {% endfor %}
        </table>
      </span>

      {# Most Recent Opponents #}
      <span id="statsNew">
        <table>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>W</th>
            <th>L</th>
            {# <th>D</th> #}
          </tr>
          {% for o in stats.recent %}
            <tr title="Click to filter by games against {{o[3]}}" class="clickable" onclick="changeAgainst('{{o[3]}}')">
              {% if o[0] > o[1] %}
                {% if o[1] == 0 %}
                  {% set outcome = "p" %}
                {% else %}
                  {% set outcome = "w" %}
                {% endif %}
              {% elif o[1] > o[0] %}
                {% if o[0] == 0 %}
                  {% set outcome = "f" %}
                {% else %}
                  {% set outcome = "l" %}
                {% endif %}
              {% else %}
                {% set outcome = "d" %}
              {% endif %}
              {# <td><a href="/stats/{{ o[3]|replace('#', '_', 1) }}{{DEF_STATS}}">{{ o[3] }}</a></td> #}
              <td class="conncode" onclick="changeAgainst('{{o[3]}}')">{{ o[3] }}</td>
              {# <td><a href="/stats/{{ o[3]|replace('#', '_', 1) }}?submit=">{{ o[3] }}</a></td> #}
              <td>{{ o[4] }}</td>
              <td class="w{{outcome}}">{{ o[0] }}</td>
              <td class="l{{outcome}}">{{ o[1] }}</td>
              {# <td>{{ o[2] }}</td> #}
            </tr>
          {% endfor %}
        </table>
      </span>

      {# Most Recent Games #}
      <span id="statsHistory">
        <div class="barDiv svg-container">
          {% set svg_selector = "div.bardiv" %}
          {% set jsondata     = stats["bydate"] %}
          {% include '_barchart-gamesbydate.html.j2' %}
        </div>
      </span>

    </span>

{% endblock %}
